---
layout: post
title:  渗透测试流程
date:   2018-10-19 11:14:56 +0800
img:
description: 渗透测试是指渗透人员在不同的位置（比如从内网、从外网等位置）利用各种手段对某个特定网络进行测试，以期发现和挖掘系统中存在的漏洞，然后输出渗透测试报告，并提交给网络所有者。网络所有者根据渗透人员提供的渗透测试报告，可以清晰知晓系统中存在的安全隐患和问题。
categories: web安全
---

* 目录
{:toc}

## 0x00 前言

渗透测试是指渗透人员在不同的位置（比如从内网、从外网等位置）利用各种手段对某个特定网络进行测试，以期发现和挖掘系统中存在的漏洞，然后输出渗透测试报告，并提交给网络所有者。网络所有者根据渗透人员提供的渗透测试报告，可以清晰知晓系统中存在的安全隐患和问题。<br>
渗透测试不同于入侵，入侵是不择手段的，甚至是居右破坏性的拿到系统权限

## 0x01 明确目标

当拿到一个合法的渗透测试项目时，我们首先应该明确客户要求我们进行渗透测试的范围以及整体项目的时间。
    
- 确定范围：测试目标的范围，ip，域名，内外网。
- 确定规则：能渗透到什么程度，时间？能否修改上传？能否提权？哪些社工手段不能使用等。
- 确定需求：web应用的漏洞(新上线程序)？业务逻辑漏洞（针对业务的）？人员权限管理漏洞（针对人员、权限）？等等。（立体全方位）


## 0x02 信息收集

在对一个站进行渗透测试的过程中，信息收集是非常重要的。信息收集的详细与否可能决定着此次渗透测试的成功与否。

- 真实IP查询

    企业常常为了增强网页访问速度为服务加cdn，如何查看是否做了cdn<br>
    可以通过站长工具多地ping域名，如果做了cdn的话返回IP时不一样的<br>
    如何绕过cdn查询真实IP的一些方法：<br>
    1. 直接查看子域名的ip，一般企业都只会对主域名做cdn，而常常忽略了子域名
    2. 查询历史dns记录，如果存在做了cdn之前的记录也是可以查到真实ip的
    3. 还可以使用对方的邮件服务，或者是rss订阅服务，当目标给你发送了一条消息也可以从消息中找到真实ip
    4. 利用国外的vps去ping一下域名或者使用nslookup更改dns为国外的dns都可能查到其真实ip
    5. 让服务器去访问你的vps，比如说这个网址有设置头像的方式，并且可以直接填写头像的url，那么我们可以把图片放在自己vps上提交给服务器，那么也可以从日志中得到真实ip
    6. 利用phpinfo，当然这个情况还是比较少的，因为一般都会把phpinfo给删除

- whois查询

    当拿到一个域名的时候，我们首先应该进行whois查询，可以使kali 下面的 whois命令或者使用在线工具，比如说whois查询，通过查询域名的注册人信息，我们可以对其进行社工钓鱼。或者我们可以有针对性的利用其信息生成字典，对后台或者其他登录功能进行爆破。

- 利用搜索引擎发现和侦察信息泄露，如google hacking获得后台，未授权页面，敏感url等

    利用google去搜索包括特殊文本字符串的网页
    inurl:xxx filetype:xls
    inurl:xxx site:xxx.com

- 指纹识别

    通过指纹识别，我们可以明确这个网站是用何种cms开发，操作系统版本、是否存在防护设备等，然后我们可以利用公开的对应版本的poc进行测试，当然我们也可以将对应版本的源码下载下来进行代码审计。<br>
    针对一个web服务，我们应该首先明确这个是由什么语言开发的前后端，使用的什么webserver版本和类型，因为不同的webserver也有不同的解析漏洞或者其他的漏洞。<br>
    - 使用浏览器插件(wappalyzer)可以很方便的查看这些信息<br>
    - 使用nc可以观察数据包特征或者网页加载的特殊文件来识别cms，如`nc xxx.com 80`
    - 使用burpsuite、Niketo、Whatweb等
        - HTTP 标头 ，如 X-Powered-By 字段
        - cookie 
        - HTML 源代码
        - 特定文件和文件夹

- 历史漏洞收集

    了解目标历史漏洞对我们帮助也是非常的大，至少我们可以知道网站设计人员喜欢在什么地方犯错误，喜欢犯什么类型的错误。这样我们可以有针对性的进行渗透测试，或者说我们可以查看是否已经修补过得漏洞是否能够绕过。

- 利用app进行信息收集

    可以利用工具对其进行逆向，找出其所使用的url链接，然后进行专门的渗透测试

- 敏感目录、端口、子域名信息收集

    敏感目录包括但不限于网站的备份文件，未授权访问的上传页面，文本编辑器、robots.txt或者phpmyadmin等等目录。就拿备份文件来讲，一般人拿到以后只会查看是否有数据库账号密码进行连接，如果没有就无从下手。其实我们可以通过代码审计发现它的漏洞进行渗透测试。再比如phpmyadmin，我们可以使用爆破工具对其账号密码进行爆破。或者是之前有黑阔留下的后门文件，我们也可以爆破其密码进行利用。常用工具[dirsearch](https://github.com/maurosoria/dirsearch)<br>
    当拿到一个ip的时候，我们一般都需要使用nmap或者其他同类扫描工具如masscan对其开放端口以及端口对应的服务进行扫描。通过端口开放情况，我们可以针对性的对其进行渗透测试<br>
    当对主站无从下手的时候我们可以通过子域名下手，因为一个企业可能对子域名的安全不是很重视，甚至有些子域名只是内测阶段还没有上线，所以对子域名进行渗透测试是非常重要的。常用工具[subDomainsBrute](https://github.com/lijiejie/subDomainsBrute)

- 了解网站业务功能

    我们需要对整个站点的整体功能有所了解，从注册用户到更改信息更改密码等等，所有的功能都需要尽可能体验一遍，在体验的同时就应该思考这个功能可能产生什么样的漏洞。并且需要多注册几个账号，这对后面的csrf漏洞发现或者逻辑漏洞发现等等都很有帮助

- 了解网站结构

    在开始安全测试之前, 了解应用程序的结构是至关重要的。如果不彻底了解应用程序的布局, 就不可能对其进行彻底的测试。可以通过burpsuite自动化爬虫

- 企业员工信息收集

    拿到员工的信息，我们可以尝试使用弱密码进行登录一些内部平台，并且一些员工的邮箱的前缀很可能就是他的密码。当然，如果说当一个服务不允许多次使用错误密码登录，我们可以先确定弱口令，然后爆破收集到的账号信息去爆破哪些用户使用这个弱口令从而绕过这个防护机制。

- F12审查网页元素

    对于程序员来说, 在源代码中添加详细注释和元数据是非常普遍的,甚至是推荐的。但是, HTML 代码中包含的注释和元数据可能会对潜在攻击者暴露内部信息。应对源代码中的注释和元数据进行审查以确定是否泄露了任何信息。

## 0x03 漏洞发现

- 漏洞扫描

    关于漏洞扫描的工具太多了，一般使用awvs扫描<br>
    但是不要依赖工具，很多漏洞工具都是扫不出的，一定要结合手工测试漏洞，且扫描器扫描会插入很多脏数据。

- sql注入

    **定义**：Web程序代码中对于用户提交的参数未做过滤就直接放到SQL语句中执行，导致参数中的特殊字符打破了SQL语句原有逻辑，黑客可以利用该漏洞执行任意SQL语句。<br>
    掌握常用的sql注入手法，熟练使用sqlmap或者同类工具。还需要学会剑走偏锋，多去探索冷门的sql注入方法，这样才不会被过滤了某些字符的时候而束手无策。<br>
    **其次作为白帽子要有自己的原则和底线，即使数据再诱人，也千万不要去拿任何数据!**<br>
    何防止SQL注入：<br>
    - 不信任用户的输入；
    - 不使用动态拼接sql，可使用参数化的sql或直接使用存储过程进行数据查询存取；
    - 不使用管理员权限的数据库连接；
    - 对机密信息进行加密或hash掉密码和敏感信息；
    - 应用异常尽可能少在web提示，最好使用自定义信息对应用的异常信息进行包装；
    - 采用工具或网络平台检测是否存在SQL注入。

- xss漏洞

    **定义**：恶意攻击者往Web页面里插入恶意Script代码，当用户浏览该页之时，嵌入其中Web里面的Script代码会被执行，从而达到恶意攻击用户的目的。<br>
    前端漏洞也是一个很大的板块，在做渗透测试的时候我们需要抓住一些细微的点，对每一个输出点都尽可能的测试，并且想方设法的去绕过<br>
    如何防止XSS跨站脚本攻击：（原则是不相信用户输入的数据）<br>
    - 将重要的cookies标记为http only，这样JavaScript中的document.cookie语句就不能获取到cookie了；
    - 只允许用户输入我们期望的数据，如年龄的textbox中只允许输入数字，其余过滤；
    - 对数据进行Html Encode处理，如<转化为&lt；、&转化为&amp；
    - 过滤或移除特殊的Html标签，如：script、iframe；
    - 过滤JavaScript事件的标签，如“onclick=”、“onfocus”等等。

- xxe漏洞

    xxe漏洞如果存在的话危害是非常大的，从读取信息到探测内网等等

- 逻辑漏洞

    逻辑漏洞包括任意重置用户密码，修改订单等等，这类漏洞是扫描器所不能扫描出来的，所以需要我们认真分析整个站点的功能，分析其逻辑，多用burpsuite抓包观察数据包是否可篡改，验证码是否可爆破等等

- csrf

    **定义**：是指攻击者通过伪装来自受信任用户的请求来利用受信任的站点，强制对已完成认证的用户进行非预期的个人信息或设定信息等某种状态更新，也就是说攻击者盗用了你的身份，以你的名义发送恶意请求。<br>
    检测csrf漏洞一般是看每一个操作是否有验证码验证，是否有token或者referer,可以注册多个账户然后利用A用户生成的poc去检测B用户，poc可以通过burpsuite去生成<br>

    如何防止CSRF跨站请求攻击：<br>
    - 在web站点，将持久化的授权（例如cookie或者http授权）切换为瞬时的授权方法（在每个form中提供隐藏field）；
    - 验证码，强化用户与应用的交互，但不是任何请求都加验证码；
    - 在HTTP头中自定义属性并验证 + One time tokens；
    - 检查请求header中的referer也能帮助组织CSRF攻击，但服务器不是总能拿到referer，有些浏览器出于安全会隐私考虑会不发referer，所以也不常用； 
    - 在浏览其它站点前退出登录站点或者浏览结束后清理浏览器cookies；
    - 生成一个随机的token，在用户提交数据的同时提交这个token，服务器端对比后如果不正确，则拒绝执行操作。



- 未授权访问

    这里所指的未授权包括各种空密码之类的，这种漏洞危害是不言而喻的

- 弱口令，越权访问

    可以通过爆破的方式发现弱口令，而越权访问又包括水平越权和垂直访问，这种漏洞我们可以观察url是否带有用户的明文信息或者直接访问一些敏感页面

- 各种框架漏洞

    比如说structs这个框架的漏洞层出不穷，当明确了目标所使用何种框架之后，我们可以使用poc进行验证

- 信息泄露

    信息泄露即通过各种搜索手段或者查看robots.txt之类的敏感目录得到敏感信息

- 文件包含

    当我们在遇到文件上传并且有白名单校验的时候，利用文件包含可以轻松getshell

- 命令注入

    **定义**：针对操作系统，即能够在服务器上执行任意命令。从Web应用中通过Shell来调用操作系统命令，如果在Shell调用时存在漏洞，就可以执行攻击者的非法OS命令<br>
    命令注入的思路与sql注入思路是差不多的，都是对用户的输入过滤不严谨。<br>
    如何防止OS注入：<br>
    - 不调用外部程序；
    - 过滤掉、；，[,],|,<,>,\之类的符号；
    - 设置用户的权限。

最后需要注意的是在进行漏洞发现的时候应该对每一个事件利用burpsuite进行抓包仔细观察数据包的传送情况，不放过任何一个可利用的点。

## 0x04 漏洞验证

尽可能的由浅入深，旁敲侧推，尽可能的将漏洞的价值发挥到最大化，比如说挖到一枚self-xss ，这个漏洞一般会被忽略，如果说结合csrf漏洞的话那么就是一个中危漏洞了<br>
再比如说拿到一个企业的邮箱账户，我们可以对其vpn爆破然后进行内网探测等等都是可行的。

## 0x05 后渗透阶段

后渗透测试包括内网渗透，权限维持，权限提升，读取用户hash，浏览器密码等等，一般都是点到为止，不会深入。**这里需要注意，是要在客户允许的范围内进行测试，白帽子需要有白帽子的底线！**

## 0x06 报告编写

一个好的渗透测试报告至关重要。
只有编写完渗透测试报告这次渗透测试才算完全结束。<br>
首先你需要明确漏洞名称以及漏洞原理。
其次要注明参与人员，测试时间，内网外网<br>
- 按需整理：按照之前第一步跟客户确定好的范围，需求来整理资料，并将资料形成报告
- 补充介绍：要对漏洞成因，验证过程和带来危害进行分析
- 修补建议：当然要对所有产生的问题提出合理高效安全的解决办法


## 0x07 风险规避

1. 不要进行诸如ddos攻击，不破坏数据
1. 测试之前对重要数据进行备份
1. 任何测试执行前必须和客户进行沟通，以免引来不必要的麻烦
1. 可以对原始系统生成镜像环境，然后对镜像环境进行测试
1. 明确渗透测试范围
